<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Taskmanager</title>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@600&display=swap"
    />
    <link rel="stylesheet" href="index.css" />
    <style>
      #container_iftekhar {
        height: 700px;
        width: 1200px;
        background-color: white;
        z-index: 1000000000;
        position: absolute;
        top: 350px;
        left: 220px;
        padding: 20px;
      }

      /* Dashboard Container */
      .dashboard-container {
        max-width: 1200px;
        margin: 20px auto;
        padding: 20px;
        background-color: #ffffff;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      /* Header Section */
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        background-color: #4caf50;
        color: white;
        border-radius: 8px 8px 0 0;
      }

      header h1 {
        font-size: 2em;
        margin: 0;
      }

      .logout-container {
        display: flex;
      }

      .logout-btn {
        background-color: #f44336;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1em;
      }

      .logout-btn:hover {
        background-color: #d32f2f;
      }

      /* Search Bar */
      .search-container {
        margin-bottom: 20px;
        text-align: center;
      }

      #searchBar {
        width: 80%;
        padding: 10px;
        font-size: 1em;
        border: 2px solid #ddd;
        border-radius: 5px;
        margin: 0 auto;
        display: block;
      }

      /* Table Styles */
      table.service-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background-color: #ffffff;
      }

      table.service-table th,
      table.service-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }

      table.service-table th {
        background-color: #4caf50;
        color: white;
      }

      table.service-table tr:nth-child(even) {
        background-color: #f9f9f9;
      }

      table.service-table tr:hover {
        background-color: #ddd;
      }

      table.service-table td button {
        background-color: #4caf50;
        color: white;
        padding: 6px 12px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }

      table.service-table td button:hover {
        background-color: #45a049;
      }

      table#completedAppointments button {
        display: none;
      }

      /* Appointment Title */
      h2 {
        font-size: 1.8em;
        color: #333;
        text-align: center;
        margin-bottom: 10px;
      }

      /* Mobile Responsiveness */
      @media (max-width: 768px) {
        .dashboard-container {
          padding: 15px;
        }

        header h1 {
          font-size: 1.5em;
        }

        #searchBar {
          width: 100%;
        }

        .service-table td button {
          width: 100%;
          padding: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="main-container">
      <span class="team">Team</span>
      <div class="ellipse"></div>
      <div class="ellipse-1"></div>
      <span class="individual">Individual</span>
      <div class="ellipse-2"></div>
      <div class="flex-row">
        <span class="number-1">1</span>
        <div class="ellipse-3"></div>
      </div>
      <div class="ellipse-4"></div>
      <div class="flex-row-ebe">
        <span class="number-1-5">1</span>
        <div class="ellipse-6"></div>
      </div>
      <div class="ellipse-7"></div>
      <div class="flex-row-8">
        <span class="number-1-9">1</span>
        <div class="ellipse-a"></div>
      </div>
      <div class="ellipse-b"></div>
      <div class="ellipse-c"></div>
      <div class="ellipse-d"></div>
      <div class="flex-row-e">
        <div class="rectangle">
          <div class="flex-column-f">
            <div class="crmrs"></div>
            <a href="../employeehoursnperf/index.html">
              <div class="frame">
                <div class="vector"></div>
                <div class="vector-e"></div>
                <div class="vector-f"></div>
              </div>
            </a>
            <div class="frame-10">
              <a href="../projects/index.html">
                <div class="group">
                  <div class="vector-11"></div>
                  <div class="vector-12"></div>
                </div>
              </a>
              <div class="vector-13"></div>
              <div class="vector-14"></div>
            </div>
            <div class="frame-15">
              <a href="../team/index.html">
                <div class="group-16"></div>
              </a>
            </div>
            <a href="../calendar/index.html">
              <div class="frame-17"></div>
            </a>
          </div>
          <span class="dashboard">Dashboard</span>
        </div>
        <div class="rectangle-18"></div>
        <span class="meeting-info">Today 5:15 pm<br />Meeting with Vinod</span>
        <div class="frame-19">
          <div class="group-1a">
            <div class="flex-row-a">
              <div class="vector-1b"></div>
              <div class="vector-1c"></div>
            </div>
            <div class="flex-row-f">
              <div class="vector-1d"></div>
              <div class="vector-1e"></div>
              <div class="vector-1f"></div>
              <div class="vector-20"></div>
              <div class="group-21"><div class="vector-22"></div></div>
              <div class="vector-23"></div>
              <div class="vector-24"></div>
              <div class="vector-25"></div>
              <div class="vector-26"></div>
              <div class="vector-27"></div>
              <div class="vector-28"></div>
              <div class="vector-29"></div>
              <div class="vector-2a"></div>
              <div class="vector-2b"></div>
              <div class="vector-2c"></div>
              <div class="vector-2d"></div>
              <div class="vector-2e"></div>
              <div class="vector-2f"></div>
              <div class="vector-30"></div>
            </div>
          </div>
        </div>
        <span class="client-meeting">Client Meeting</span
        ><button class="button">
          <div class="frame-31">
            <a href="../login/index.html">
              <span class="logout">Logout</span>
            </a>
          </div>
        </button>
        <div class="line"></div>
        <div class="rectangle-32">
          <div class="no-projects-worked">
            <span class="no-of">No of<br /></span
            ><span class="projects-worked">Projects Worked</span>
          </div>
          <span class="text-c">15</span>
        </div>
        <div class="rectangle-33">
          <div class="no-teams-worked">
            <span class="no-of-34">No of<br /></span
            ><span class="teams-worked">Teams Worked</span>
          </div>
          <span class="text-f">07</span>
        </div>
        <div class="rectangle-35">
          <span class="performance-rating">84%</span
          ><span class="performance-rating-36">Performance<br />Rating</span>
        </div>
        <div class="rectangle-37">
          <span class="text-12">07</span
          ><span class="total-attendance-progress"
            >Total<br />Attendance Progress</span
          >
        </div>

        <div class="rectangle-4b">
          <span class="profile">Profile</span>
          <div class="frame-4c"><div class="group-4d"></div></div>
        </div>
      </div>
    </div>
    <div id="container_iftekhar">
      <input type="hidden" id="customer_id" />

      <div class="appointments-container">
        <div class="search-container">
          <input
            type="text"
            id="searchBar"
            placeholder="Search by customer name or service..."
          />
        </div>

        <!-- Upcoming Appointments -->
        <h2>Upcoming Appointments</h2>
        <table class="service-table" id="upcomingAppointments">
          <thead>
            <tr>
              <th>Date</th>
              <th>Customer</th>
              <th>Service</th>
              <th>Mileage</th>
              <th>Location</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Dynamic content will be injected here -->
          </tbody>
        </table>

        <!-- Completed Appointments -->
        <h2>Completed Appointments</h2>
        <table class="service-table" id="completedAppointments">
          <thead>
            <tr>
              <th>Date</th>
              <th>Customer</th>
              <th>Service</th>
              <th>Mileage</th>
              <th>Location</th>
            </tr>
          </thead>
          <tbody>
            <!-- Dynamic content will be injected here -->
          </tbody>
        </table>
      </div>
    </div>
    <script>
      // Retrieve mechanic ID from logged-in user (could be stored in localStorage/session)
      function getLoggedInUser() {
        // Retrieve user data from localStorage
        const user = JSON.parse(localStorage.getItem("user"));
        const userid = JSON.parse(localStorage.getItem("userid"));

        console.log(userid);
        if (user) {
          // Update the element with the user's name
          document.getElementById("customer_id").value = userid;

          console.log(`Logged in as: ${user.username}`);
        } else {
          console.log("No user is logged in.");
        }
      }

      getLoggedInUser();

      // Fetch appointments for the logged-in mechanic
      function fetchAppointments() {
        const mechanicId = document.getElementById("customer_id").value;

        if (!mechanicId) {
          console.log("Mechanic ID is missing.");
          return;
        }

        // Make a GET request to fetch appointments for the logged-in mechanic
        fetch(
          `http://localhost:3000/appointments/mechanic?mechanicId=${mechanicId}`
        )
          .then((response) => response.json())
          .then((data) => {
            populateAppointments("upcomingAppointments", data.upcoming);
            populateAppointments("completedAppointments", data.completed);
          })
          .catch((error) =>
            console.error("Error fetching appointments:", error)
          );
      }

      // Populate the table with appointment data
      function populateAppointments(tableId, appointments) {
        const table = document.getElementById(tableId);
        const tbody = table.querySelector("tbody");
        tbody.innerHTML = ""; // Clear the table

        appointments.forEach((appointment) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${appointment.date}</td>
            <td>${appointment.customerId}</td>
            <td>${appointment.serviceType}</td>
            <td>Not Calculated</td>
            <td>Main Branch</td>
            <td><button onclick="markAsCompleted('${appointment.id}')">Mark as Completed</button></td>
          `;
          tbody.appendChild(row);
        });
      }

      // Mark an appointment as completed
      function markAsCompleted(appointmentId) {
        confirm("Are you sure you want to make this task as completed?");
        fetch(`http://localhost:3000/appointments/complete/${appointmentId}`, {
          method: "POST",
        })
          .then((response) => response.json())
          .then((data) => {
            alert("Appointment marked as completed!");
            alert("Sending the customer a notifciation...");
            fetchAppointments(); // Re-fetch appointments after updating status
          })
          .catch((error) =>
            console.error("Error marking appointment as completed:", error)
          );
      }

      // Search functionality for filtering appointments by customer or service
      document
        .getElementById("searchBar")
        .addEventListener("input", function () {
          const searchQuery = this.value.toLowerCase();
          const rows = document.querySelectorAll("table tbody tr");

          rows.forEach((row) => {
            const customerName = row.cells[1].textContent.toLowerCase();
            const service = row.cells[2].textContent.toLowerCase();

            if (
              customerName.includes(searchQuery) ||
              service.includes(searchQuery)
            ) {
              row.style.display = "";
            } else {
              row.style.display = "none";
            }
          });
        });

      // Fetch and display appointments when the page loads
      window.onload = fetchAppointments;
    </script>
  </body>
</html>
